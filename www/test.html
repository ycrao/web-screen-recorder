<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“å½•åˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        #testVideo {
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .format-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ åª’ä½“å½•åˆ¶åŠŸèƒ½æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„åª’ä½“å½•åˆ¶åŠŸèƒ½ï¼Œæ£€æŸ¥å„ç§å…¼å®¹æ€§å’Œé”™è¯¯å¤„ç†æƒ…å†µã€‚</p>
        
        <div class="section">
            <h3>ğŸ” æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥</h3>
            <button class="test-button" onclick="testBrowserCompatibility()">è¿è¡Œå…¼å®¹æ€§æµ‹è¯•</button>
            <div id="compatibilityResults"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“¹ åª’ä½“æ ¼å¼æ”¯æŒæµ‹è¯•</h3>
            <button class="test-button" onclick="testMediaFormats()">æµ‹è¯•æ”¯æŒçš„æ ¼å¼</button>
            <div id="formatResults"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ¥ åª’ä½“æµåˆ›å»ºæµ‹è¯•</h3>
            <div>
                <button class="test-button" onclick="testCameraAccess()">æµ‹è¯•æ‘„åƒå¤´è®¿é—®</button>
                <button class="test-button" onclick="testScreenCapture()">æµ‹è¯•å±å¹•å½•åˆ¶</button>
                <button class="test-button" onclick="testTabCapture()">æµ‹è¯•æ ‡ç­¾é¡µå½•åˆ¶</button>
            </div>
            <video id="testVideo" controls style="display: none;"></video>
            <div id="streamResults"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ”„ MediaRecorder åˆ›å»ºæµ‹è¯•</h3>
            <button class="test-button" onclick="testMediaRecorderCreation()">æµ‹è¯• MediaRecorder åˆ›å»º</button>
            <div id="recorderResults"></div>
        </div>
        
        <div class="section">
            <h3>âš¡ ç»¼åˆå½•åˆ¶æµ‹è¯•</h3>
            <p>æµ‹è¯•å®Œæ•´çš„å½•åˆ¶æµç¨‹ï¼ˆåŒ…æ‹¬æƒé™è¯·æ±‚å’Œé”™è¯¯å¤„ç†ï¼‰ï¼š</p>
            <button class="test-button" onclick="runFullRecordingTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="fullTestResults"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ul>
                <li>ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®æ¥éªŒè¯ä¸åŒçš„åŠŸèƒ½</li>
                <li>æŸäº›æµ‹è¯•éœ€è¦ç”¨æˆ·æˆæƒï¼Œè¯·å…è®¸æµè§ˆå™¨è®¿é—®æƒé™</li>
                <li>æµ‹è¯•ç»“æœä¼šæ˜¾ç¤ºåœ¨ç›¸åº”çš„åŒºåŸŸä¸­</li>
                <li>å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
            </ul>
        </div>
    </div>

    <script>
        // æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥
        function testBrowserCompatibility() {
            const results = document.getElementById('compatibilityResults');
            let issues = [];
            let warnings = [];
            
            // æ£€æŸ¥åŸºæœ¬APIæ”¯æŒ
            if (!navigator.mediaDevices) {
                issues.push('ç¼ºå°‘ MediaDevices API');
            } else {
                results.innerHTML += '<div class="test-result success">âœ“ MediaDevices API æ”¯æŒ</div>';
            }
            
            if (!navigator.mediaDevices.getUserMedia) {
                issues.push('ä¸æ”¯æŒ getUserMedia');
            } else {
                results.innerHTML += '<div class="test-result success">âœ“ getUserMedia æ”¯æŒ</div>';
            }
            
            if (!MediaRecorder) {
                issues.push('ä¸æ”¯æŒ MediaRecorder API');
            } else {
                results.innerHTML += '<div class="test-result success">âœ“ MediaRecorder API æ”¯æŒ</div>';
            }
            
            if (!navigator.mediaDevices.getDisplayMedia) {
                issues.push('ä¸æ”¯æŒå±å¹•å½•åˆ¶ (getDisplayMedia)');
                results.innerHTML += '<div class="test-result warning">âš  å±å¹•å½•åˆ¶ä¸æ”¯æŒ</div>';
            } else {
                results.innerHTML += '<div class="test-result success">âœ“ å±å¹•å½•åˆ¶æ”¯æŒ</div>';
            }
            
            // æ£€æŸ¥HTTPSç¯å¢ƒ
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                warnings.push('éœ€è¦åœ¨HTTPSç¯å¢ƒä¸‹ä½¿ç”¨ï¼ˆæŸäº›APIéœ€è¦å®‰å…¨ä¸Šä¸‹æ–‡ï¼‰');
                results.innerHTML += '<div class="test-result warning">âš  éHTTPSç¯å¢ƒ</div>';
            } else {
                results.innerHTML += '<div class="test-result success">âœ“ å®‰å…¨ä¸Šä¸‹æ–‡</div>';
            }
            
            if (issues.length > 0) {
                results.innerHTML += '<div class="test-result error">âŒ å…¼å®¹æ€§é—®é¢˜: ' + issues.join(', ') + '</div>';
            }
            
            if (warnings.length > 0) {
                results.innerHTML += '<div class="test-result warning">âš  æ³¨æ„äº‹é¡¹: ' + warnings.join(', ') + '</div>';
            }
            
            // è®°å½•è¯¦ç»†ä¿¡æ¯
            console.log('æµè§ˆå™¨ä¿¡æ¯:', {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language
            });
        }
        
        // åª’ä½“æ ¼å¼æ”¯æŒæµ‹è¯•
        function testMediaFormats() {
            const results = document.getElementById('formatResults');
            const testFormats = [
                'video/webm;codecs=vp8,vorbis',
                'video/webm;codecs=vp8',
                'video/webm',
                'video/mp4;codecs=h264',
                'video/mp4',
                'video/mpeg'
            ];
            
            results.innerHTML += '<div class="format-list"><strong>æµ‹è¯•çš„æ ¼å¼:</strong><br>';
            
            testFormats.forEach(format => {
                if (MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(format)) {
                    results.innerHTML += `<div class="test-result success">âœ“ ${format}</div>`;
                } else {
                    results.innerHTML += `<div class="test-result error">âœ— ${format}</div>`;
                }
            });
            
            results.innerHTML += '</div>';
        }
        
        // æ‘„åƒå¤´è®¿é—®æµ‹è¯•
        async function testCameraAccess() {
            const results = document.getElementById('streamResults');
            const video = document.getElementById('testVideo');
            
            try {
                results.innerHTML += '<div class="test-result">æ­£åœ¨æµ‹è¯•æ‘„åƒå¤´è®¿é—®...</div>';
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                results.innerHTML += '<div class="test-result success">âœ“ æ‘„åƒå¤´è®¿é—®æˆåŠŸ</div>';
                
                // æ˜¾ç¤ºè½¨é“ä¿¡æ¯
                const videoTracks = stream.getVideoTracks();
                const audioTracks = stream.getAudioTracks();
                
                results.innerHTML += `<div class="test-result success">âœ“ è§†é¢‘è½¨é“: ${videoTracks.length} ä¸ª</div>`;
                results.innerHTML += `<div class="test-result success">âœ“ éŸ³é¢‘è½¨é“: ${audioTracks.length} ä¸ª</div>`;
                
                // 5ç§’ååœæ­¢
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    results.innerHTML += '<div class="test-result">æµå·²åœæ­¢</div>';
                }, 5000);
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    results.innerHTML += '<div class="test-result error">âŒ æƒé™è¢«æ‹’ç»</div>';
                } else if (error.name === 'NotFoundError') {
                    results.innerHTML += '<div class="test-result error">âŒ æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡</div>';
                }
            }
        }
        
        // å±å¹•å½•åˆ¶æµ‹è¯•
        async function testScreenCapture() {
            const results = document.getElementById('streamResults');
            const video = document.getElementById('testVideo');
            
            try {
                results.innerHTML += '<div class="test-result">æ­£åœ¨æµ‹è¯•å±å¹•å½•åˆ¶...</div>';
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        mediaSource: 'screen',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    },
                    audio: true
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                results.innerHTML += '<div class="test-result success">âœ“ å±å¹•å½•åˆ¶æˆåŠŸ</div>';
                
                // æ˜¾ç¤ºè½¨é“ä¿¡æ¯
                const videoTracks = stream.getVideoTracks();
                const audioTracks = stream.getAudioTracks();
                
                results.innerHTML += `<div class="test-result success">âœ“ è§†é¢‘è½¨é“: ${videoTracks.length} ä¸ª</div>`;
                if (audioTracks.length > 0) {
                    results.innerHTML += `<div class="test-result success">âœ“ éŸ³é¢‘è½¨é“: ${audioTracks.length} ä¸ª</div>`;
                }
                
                // 5ç§’ååœæ­¢
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    results.innerHTML += '<div class="test-result">æµå·²åœæ­¢</div>';
                }, 5000);
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">âŒ å±å¹•å½•åˆ¶å¤±è´¥: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    results.innerHTML += '<div class="test-result error">âŒ ç”¨æˆ·æ‹’ç»å±å¹•å…±äº«æƒé™</div>';
                } else if (error.name === 'NotSupportedError') {
                    results.innerHTML += '<div class="test-result error">âŒ æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å½•åˆ¶</div>';
                }
            }
        }
        
        // æ ‡ç­¾é¡µå½•åˆ¶æµ‹è¯•
        async function testTabCapture() {
            const results = document.getElementById('streamResults');
            const video = document.getElementById('testVideo');
            
            try {
                results.innerHTML += '<div class="test-result">æ­£åœ¨æµ‹è¯•æ ‡ç­¾é¡µå½•åˆ¶...</div>';
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        mediaSource: 'tab',
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                });
                
                video.srcObject = stream;
                video.style.display = 'block';
                results.innerHTML += '<div class="test-result success">âœ“ æ ‡ç­¾é¡µå½•åˆ¶æˆåŠŸ</div>';
                
                // 5ç§’ååœæ­¢
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    results.innerHTML += '<div class="test-result">æµå·²åœæ­¢</div>';
                }, 5000);
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">âŒ æ ‡ç­¾é¡µå½•åˆ¶å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // MediaRecorder åˆ›å»ºæµ‹è¯•
        function testMediaRecorderCreation() {
            const results = document.getElementById('recorderResults');
            
            try {
                results.innerHTML += '<div class="test-result">æ­£åœ¨æµ‹è¯• MediaRecorder åˆ›å»º...</div>';
                
                // æµ‹è¯•ä¸åŒçš„æ ¼å¼
                const testFormats = [
                    'video/webm;codecs=vp8,vorbis',
                    'video/webm;codecs=vp8',
                    'video/webm',
                    'video/mp4;codecs=h264'
                ];
                
                let successCount = 0;
                
                testFormats.forEach(format => {
                    try {
                        // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ MediaStream æ¥æµ‹è¯•
                        const dummyStream = new MediaStream();
                        const recorder = new MediaRecorder(dummyStream, { mimeType: format });
                        results.innerHTML += `<div class="test-result success">âœ“ ${format} - åˆ›å»ºæˆåŠŸ</div>`;
                        successCount++;
                    } catch (error) {
                        results.innerHTML += `<div class="test-result error">âœ— ${format} - ${error.message}</div>`;
                    }
                });
                
                // æµ‹è¯•é»˜è®¤åˆ›å»ºï¼ˆä¸æŒ‡å®šæ ¼å¼ï¼‰
                try {
                    const dummyStream = new MediaStream();
                    const recorder = new MediaRecorder(dummyStream);
                    results.innerHTML += '<div class="test-result success">âœ“ é»˜è®¤æ ¼å¼ - åˆ›å»ºæˆåŠŸ</div>';
                    successCount++;
                } catch (error) {
                    results.innerHTML += `<div class="test-result error">âœ— é»˜è®¤æ ¼å¼ - ${error.message}</div>`;
                }
                
                results.innerHTML += `<div class="test-result ${successCount > 0 ? 'success' : 'error'}">æ€»è®¡: ${successCount} ä¸ªæ ¼å¼æ”¯æŒ</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">âŒ MediaRecorder æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // å®Œæ•´å½•åˆ¶æµç¨‹æµ‹è¯•
        async function runFullRecordingTest() {
            const results = document.getElementById('fullTestResults');
            
            results.innerHTML += '<div class="test-result">å¼€å§‹å®Œæ•´å½•åˆ¶æµ‹è¯•...</div>';
            
            try {
                // 1. åˆ›å»ºåª’ä½“æµ
                results.innerHTML += '<div class="test-result">1. åˆ›å»ºåª’ä½“æµ...</div>';
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: true
                });
                results.innerHTML += '<div class="test-result success">âœ“ åª’ä½“æµåˆ›å»ºæˆåŠŸ</div>';
                
                // 2. åˆ›å»º MediaRecorder
                results.innerHTML += '<div class="test-result">2. åˆ›å»º MediaRecorder...</div>';
                
                // æ£€æµ‹æ”¯æŒçš„æ ¼å¼
                const supportedFormats = [];
                const testFormats = [
                    'video/webm;codecs=vp8,vorbis',
                    'video/webm;codecs=vp8',
                    'video/webm'
                ];
                
                for (const format of testFormats) {
                    if (MediaRecorder.isTypeSupported(format)) {
                        supportedFormats.push(format);
                    }
                }
                
                let recorder;
                if (supportedFormats.length > 0) {
                    try {
                        recorder = new MediaRecorder(stream, { mimeType: supportedFormats[0] });
                        results.innerHTML += `<div class="test-result success">âœ“ MediaRecorder åˆ›å»ºæˆåŠŸ (${supportedFormats[0]})</div>`;
                    } catch (error) {
                        recorder = new MediaRecorder(stream);
                        results.innerHTML += '<div class="test-result warning">âš  ä½¿ç”¨é»˜è®¤æ ¼å¼åˆ›å»º MediaRecorder</div>';
                    }
                } else {
                    recorder = new MediaRecorder(stream);
                    results.innerHTML += '<div class="test-result warning">âš  ä½¿ç”¨é»˜è®¤æ ¼å¼åˆ›å»º MediaRecorder</div>';
                }
                
                // 3. å¼€å§‹å½•åˆ¶
                results.innerHTML += '<div class="test-result">3. å¼€å§‹å½•åˆ¶...</div>';
                
                const chunks = [];
                recorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                recorder.start();
                results.innerHTML += '<div class="test-result success">âœ“ å½•åˆ¶å¼€å§‹</div>';
                
                // å½•åˆ¶3ç§’
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // 4. åœæ­¢å½•åˆ¶
                results.innerHTML += '<div class="test-result">4. åœæ­¢å½•åˆ¶...</div>';
                recorder.stop();
                results.innerHTML += '<div class="test-result success">âœ“ å½•åˆ¶åœæ­¢</div>';
                
                // 5. å¤„ç†å½•åˆ¶æ•°æ®
                results.innerHTML += '<div class="test-result">5. å¤„ç†å½•åˆ¶æ•°æ®...</div>';
                
                if (chunks.length > 0) {
                    const blob = new Blob(chunks, { type: recorder.mimeType || 'video/webm' });
                    results.innerHTML += `<div class="test-result success">âœ“ å½•åˆ¶æ–‡ä»¶åˆ›å»ºæˆåŠŸ (${blob.size} bytes)</div>`;
                    results.innerHTML += `<div class="test-result success">âœ“ MIMEç±»å‹: ${recorder.mimeType || 'video/webm'}</div>`;
                } else {
                    results.innerHTML += '<div class="test-result warning">âš  æœªç”Ÿæˆå½•åˆ¶æ•°æ®</div>';
                }
                
                // æ¸…ç†
                stream.getTracks().forEach(track => track.stop());
                
                results.innerHTML += '<div class="test-result success">ğŸ‰ å®Œæ•´å½•åˆ¶æµ‹è¯•å®Œæˆï¼</div>';
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    results.innerHTML += '<div class="test-result error">âŒ è¯·å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™</div>';
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œå…¼å®¹æ€§æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            console.log('åª’ä½“å½•åˆ¶æµ‹è¯•é¡µé¢å·²åŠ è½½');
            testBrowserCompatibility();
        });
    </script>
</body>
</html>
